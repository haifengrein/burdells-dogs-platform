name: Deploy to AWS

on:
  push:
    branches: ["main", "deployment/aws"]

env:
  IMAGE_NAME: "burdells-dogs-db"

jobs:
  build-and-pack:
    runs-on: "ubuntu-latest"
    permissions:
      contents: "read"

    steps:
      - uses: "actions/checkout@v4"

      - name: "Set up Docker Buildx"
        uses: "docker/setup-buildx-action@v3"

      - name: "Prepare image artifacts directory"
        run: mkdir -p "deploy-images"

      - name: "Build image (export tar)"
        uses: "docker/build-push-action@v4"
        with:
          context: "."
          file: "deploy/Dockerfile"
          tags: "${{ env.IMAGE_NAME }}:latest"
          outputs: "type=docker,dest=deploy-images/${{ env.IMAGE_NAME }}.tar"

      - name: "Compress image tar"
        run: gzip -9 "deploy-images/${{ env.IMAGE_NAME }}.tar"

      - name: "Upload image artifact"
        uses: "actions/upload-artifact@v4"
        with:
          name: "deploy-images"
          path: "deploy-images/*.tar.gz"

  deploy:
    needs: "build-and-pack"
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v4"

      - name: "Download image artifact"
        uses: "actions/download-artifact@v4"
        with:
          name: "deploy-images"
          path: "deploy-images"

      - name: "Generate .env for OAuth2"
        env:
          GOOGLE_CLIENT_ID: "${{ secrets.GOOGLE_CLIENT_ID }}"
          GOOGLE_CLIENT_SECRET: "${{ secrets.GOOGLE_CLIENT_SECRET }}"
          SECRET_KEY: "${{ secrets.SECRET_KEY }}"
          PUBLIC_APP_ORIGIN: "${{ secrets.PUBLIC_APP_ORIGIN }}"
          GOOGLE_REDIRECT_URI: "${{ secrets.GOOGLE_REDIRECT_URI }}"
          MYSQL_ROOT_PASSWORD: "${{ secrets.MYSQL_ROOT_PASSWORD }}"
          DB_USER: "${{ secrets.DB_USER }}"
          DB_PASSWORD: "${{ secrets.DB_PASSWORD }}"
          DB_NAME: "${{ secrets.DB_NAME }}"
          DB_PORT: "${{ secrets.DB_PORT }}"
        run: |
          if [ -z "$GOOGLE_CLIENT_ID" ] || [ -z "$GOOGLE_CLIENT_SECRET" ]; then
            echo "ERROR: missing GOOGLE_CLIENT_ID/GOOGLE_CLIENT_SECRET secrets." >&2
            exit 1
          fi
          if [ -z "$SECRET_KEY" ]; then
            echo "ERROR: missing SECRET_KEY secret (required for JWT/session consistency)." >&2
            exit 1
          fi

          if [ -z "${PUBLIC_APP_ORIGIN:-}" ]; then
            PUBLIC_APP_ORIGIN="https://db.haifenghou.com"
          fi
          if [ -z "${GOOGLE_REDIRECT_URI:-}" ]; then
            GOOGLE_REDIRECT_URI="${PUBLIC_APP_ORIGIN%/}/api/v1/auth/google/callback"
          fi

          MYSQL_ROOT_PASSWORD="${MYSQL_ROOT_PASSWORD:-rootpassword}"
          DB_USER="${DB_USER:-gatechUser}"
          DB_PASSWORD="${DB_PASSWORD:-gatech123}"
          DB_NAME="${DB_NAME:-burdells_dogs_db}"
          DB_PORT="${DB_PORT:-3306}"
          DB_HOST="burdells-db"

          {
            printf "MYSQL_ROOT_PASSWORD=%s\n" "$MYSQL_ROOT_PASSWORD"
            printf "MYSQL_DATABASE=%s\n" "$DB_NAME"
            printf "MYSQL_USER=%s\n" "$DB_USER"
            printf "MYSQL_PASSWORD=%s\n" "$DB_PASSWORD"
            printf "DB_USER=%s\n" "$DB_USER"
            printf "DB_PASSWORD=%s\n" "$DB_PASSWORD"
            printf "DB_NAME=%s\n" "$DB_NAME"
            printf "DB_HOST=%s\n" "$DB_HOST"
            printf "DB_PORT=%s\n" "$DB_PORT"
            printf "GOOGLE_CLIENT_ID=%s\n" "$GOOGLE_CLIENT_ID"
            printf "GOOGLE_CLIENT_SECRET=%s\n" "$GOOGLE_CLIENT_SECRET"
            printf "SECRET_KEY=%s\n" "$SECRET_KEY"
            printf "PUBLIC_APP_ORIGIN=%s\n" "$PUBLIC_APP_ORIGIN"
            printf "GOOGLE_REDIRECT_URI=%s\n" "$GOOGLE_REDIRECT_URI"
          } > ".env"

      - name: "Copy deployment files to server"
        uses: "appleboy/scp-action@v0.1.7"
        with:
          host: "${{ secrets.SERVER_IP }}"
          username: "ubuntu"
          key: "${{ secrets.SSH_PRIVATE_KEY }}"
          source: "deploy/docker-compose.prod.yml,app/database,deploy-images/${{ env.IMAGE_NAME }}.tar.gz,.env"
          target: "~/burdells_dogs_db"

      - name: "Deploy on server"
        uses: "appleboy/ssh-action@v1.0.3"
        with:
          host: "${{ secrets.SERVER_IP }}"
          username: "ubuntu"
          key: "${{ secrets.SSH_PRIVATE_KEY }}"
          script: |
            set -eu
            APP_DIR="$HOME/burdells_dogs_db"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            echo "user=$(id -un) groups=$(id -nG)"

            USE_SUDO=0
            if ! docker info >/dev/null 2>&1; then
              if sudo -n true 2>/dev/null; then
                USE_SUDO=1
              else
                echo "ERROR: docker requires sudo; configure docker group or passwordless sudo." >&2
                exit 1
              fi
            fi

            run_docker() {
              if [ "$USE_SUDO" -eq 1 ]; then
                sudo -n docker "$@"
              else
                docker "$@"
              fi
            }

            run_docker --version

            gzip -dc "deploy-images/${{ env.IMAGE_NAME }}.tar.gz" | run_docker load
            export WEB_IMAGE="${{ env.IMAGE_NAME }}:latest"

            APP_NETWORK_NAME="burdells-net"
            EDGE_NETWORK_NAME="edge-net"
            DB_VOLUME_NAME="burdells_db_data"

            run_docker network inspect "$APP_NETWORK_NAME" >/dev/null 2>&1 || run_docker network create "$APP_NETWORK_NAME" >/dev/null
            run_docker network inspect "$EDGE_NETWORK_NAME" >/dev/null 2>&1 || run_docker network create "$EDGE_NETWORK_NAME" >/dev/null
            run_docker volume inspect "$DB_VOLUME_NAME" >/dev/null 2>&1 || run_docker volume create "$DB_VOLUME_NAME" >/dev/null

            rotate_container() {
              name="$1"
              ts="$(date +%s)"
              if run_docker ps -a --format '{{.Names}}' | grep -Fxq "$name"; then
                run_docker stop "$name" >/dev/null 2>&1 || true
                run_docker rename "$name" "${name}-old-${ts}" >/dev/null 2>&1 || true
              fi
            }

            rotate_container "deploy_db_1"
            rotate_container "deploy_web_1"
            rotate_container "deploy_api_1"
            rotate_container "burdells-db"
            rotate_container "burdells-web"
            rotate_container "burdells-api"

            run_docker pull "mysql:8.0" >/dev/null
            run_docker run -d \
              --name "burdells-db" \
              --restart "always" \
              --network "$APP_NETWORK_NAME" \
              --env-file "$APP_DIR/.env" \
              -v "${DB_VOLUME_NAME}:/var/lib/mysql" \
              -v "$APP_DIR/app/database:/docker-entrypoint-initdb.d:ro" \
              "mysql:8.0" >/dev/null

            echo "Waiting for MySQL to be ready..."
            i=1
            while [ "$i" -le 60 ]; do
              if run_docker exec "burdells-db" sh -lc 'mysqladmin ping -h 127.0.0.1 -uroot -p"$MYSQL_ROOT_PASSWORD" --silent' >/dev/null 2>&1; then
                echo "MySQL is ready."
                break
              fi
              sleep 1
              i=$((i + 1))
            done
            if [ "$i" -gt 60 ]; then
              echo "ERROR: MySQL did not become ready in time." >&2
              run_docker logs --tail 200 "burdells-db" || true
              exit 1
            fi

            if [ ! -f "$APP_DIR/.env" ]; then
              echo "ERROR: missing $APP_DIR/.env (OAuth2 secrets file)." >&2
              exit 1
            fi

            run_docker run -d \
              --name "burdells-web" \
              --restart "always" \
              --network "$APP_NETWORK_NAME" \
              --env-file "$APP_DIR/.env" \
              -e "FLASK_DEBUG=0" \
              -e "WEB_CONCURRENCY=2" \
              "$WEB_IMAGE" >/dev/null

            run_docker network connect --alias "burdells-web" "$EDGE_NETWORK_NAME" "burdells-web" >/dev/null 2>&1 || true

            run_docker run -d \
              --name "burdells-api" \
              --restart "always" \
              --network "$APP_NETWORK_NAME" \
              --env-file "$APP_DIR/.env" \
              "$WEB_IMAGE" \
              /app/.venv/bin/uvicorn backend.main:app --host 0.0.0.0 --port 8000 >/dev/null

            run_docker network connect --alias "burdells-api" "$EDGE_NETWORK_NAME" "burdells-api" >/dev/null 2>&1 || true

            run_docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
