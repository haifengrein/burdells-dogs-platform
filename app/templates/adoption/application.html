{% extends "layout.html" %}

{% block title %}Add Adoption Application | Burdell's Devoted Dogs{% endblock %}

{% block main_content %}
<div class="row mb-4 align-items-center">
    <div class="col-md-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                <li class="breadcrumb-item active">Add Adoption Application</li>
            </ol>
        </nav>
        <h1 class="mb-0">
            <i class="fas fa-file-alt me-2 text-primary"></i>Add Adoption Application
        </h1>
        <p class="text-muted">Enter information for a new adoption application</p>
    </div>
    <div class="col-md-4 text-md-end">
        <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user me-2"></i>Applicant Information
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('adoption.add_app') }}" class="needs-validation" novalidate id="application-form">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="section-heading">Personal Details</h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="firstname" class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="firstname" name="firstname" required>
                            <div class="invalid-feedback">
                                Please enter a first name.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastname" class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="lastname" name="lastname" required>
                            <div class="invalid-feedback">
                                Please enter a last name.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email Address <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" name="email" required>
                            <div class="invalid-feedback">
                                Please enter a valid email address.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phone_number" class="form-label">Phone Number <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                                   pattern="^(\+\d{1,2}\s)?\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$" required>
                            <div class="invalid-feedback">
                                Please enter a valid phone number.
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="section-heading">Address</h6>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="street" class="form-label">Street Address <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="street" name="street" required>
                            <div class="invalid-feedback">
                                Please enter a street address.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="city" class="form-label">City <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="city" name="city" required>
                            <div class="invalid-feedback">
                                Please enter a city.
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="state" class="form-label">State <span class="text-danger">*</span></label>
                            <select class="form-select" id="state" name="state" required>
                                <option value="" selected disabled>Select</option>
                                <option value="AL">Alabama</option>
                                <option value="AK">Alaska</option>
                                <option value="AZ">Arizona</option>
                                <option value="AR">Arkansas</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="CT">Connecticut</option>
                                <option value="DE">Delaware</option>
                                <option value="DC">District of Columbia</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <option value="HI">Hawaii</option>
                                <option value="ID">Idaho</option>
                                <option value="IL">Illinois</option>
                                <option value="IN">Indiana</option>
                                <option value="IA">Iowa</option>
                                <option value="KS">Kansas</option>
                                <option value="KY">Kentucky</option>
                                <option value="LA">Louisiana</option>
                                <option value="ME">Maine</option>
                                <option value="MD">Maryland</option>
                                <option value="MA">Massachusetts</option>
                                <option value="MI">Michigan</option>
                                <option value="MN">Minnesota</option>
                                <option value="MS">Mississippi</option>
                                <option value="MO">Missouri</option>
                                <option value="MT">Montana</option>
                                <option value="NE">Nebraska</option>
                                <option value="NV">Nevada</option>
                                <option value="NH">New Hampshire</option>
                                <option value="NJ">New Jersey</option>
                                <option value="NM">New Mexico</option>
                                <option value="NY">New York</option>
                                <option value="NC">North Carolina</option>
                                <option value="ND">North Dakota</option>
                                <option value="OH">Ohio</option>
                                <option value="OK">Oklahoma</option>
                                <option value="OR">Oregon</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="RI">Rhode Island</option>
                                <option value="SC">South Carolina</option>
                                <option value="SD">South Dakota</option>
                                <option value="TN">Tennessee</option>
                                <option value="TX">Texas</option>
                                <option value="UT">Utah</option>
                                <option value="VT">Vermont</option>
                                <option value="VA">Virginia</option>
                                <option value="WA">Washington</option>
                                <option value="WV">West Virginia</option>
                                <option value="WI">Wisconsin</option>
                                <option value="WY">Wyoming</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a state.
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="zipcode" class="form-label">Zip Code <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="zipcode" name="zipcode" 
                                   pattern="^\d{5}(-\d{4})?$" required>
                            <div class="invalid-feedback">
                                Please enter a valid zip code.
                            </div>
                        </div>
                    </div>

        
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="section-heading">Household Information</h6>
                        </div>
                        <div class="col-md-6">
                            <label for="household_size" class="form-label">Household Size <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="household_size" name="household_size" 
                                   min="1" required>
                            <div class="invalid-feedback">
                                Please enter a valid household size.
                            </div>
                            
                        </div>
                    </div>

                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="section-heading">Application Details</h6>
                        </div>
                        <div class="col-md-6">
                            <label for="application_date" class="form-label">Application Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="application_date" name="application_date" 
                                   value="{{ today }}" max="{{ today }}" required>
                            <div class="invalid-feedback">
                                Please select a valid application date.
                            </div>
                        </div>
                    </div>

                    
                    <hr class="my-4">
                    
                    
                    <div class="d-flex justify-content-between align-items-center">
                        
                        <div>
                            <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            <button type="submit" class="btn btn-primary" id="submit-button">
                                <i class="fas fa-save me-1"></i> Submit Application
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
       
        const form = document.getElementById('application-form');
        
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            } else {
                
                document.getElementById('submit-button').disabled = true;
                document.getElementById('submit-button').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Submitting...';
            }
            
            form.classList.add('was-validated');
        });
        
    
        const emailInput = document.getElementById('email');
        const firstnameInput = document.getElementById('firstname');
        const lastnameInput = document.getElementById('lastname');
        
        emailInput.addEventListener('change', function() {
            const email = this.value.trim();
            if (email && this.validity.valid) {
                
                fetch(`/adoption/check-email?email=${encodeURIComponent(email)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            
                            if (!firstnameInput.value) {
                                firstnameInput.value = data.firstname || '';
                            }
                            if (!lastnameInput.value) {
                                lastnameInput.value = data.lastname || '';
                            }
                            
                            
                            if (data.has_application_today) {
                                const alertDiv = document.createElement('div');
                                alertDiv.className = 'alert alert-warning mt-2';
                                alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i> This email already has an application submitted today.';
                                emailInput.parentNode.appendChild(alertDiv);
                            }
                        }
                    })
                    .catch(error => console.error('Error checking email:', error));
            }
        });
        
       
        const phoneInput = document.getElementById('phone_number');
        
        phoneInput.addEventListener('input', function(e) {
           
            let input = this.value.replace(/\D/g, '');
            let formattedInput = '';
            
        
            if (input.length <= 3) {
                formattedInput = input;
            } else if (input.length <= 6) {
                formattedInput = `(${input.substring(0, 3)}) ${input.substring(3)}`;
            } else if (input.length <= 10) {
                formattedInput = `(${input.substring(0, 3)}) ${input.substring(3, 6)}-${input.substring(6)}`;
            } else {
                formattedInput = `(${input.substring(0, 3)}) ${input.substring(3, 6)}-${input.substring(6, 10)}`;
            }
            
            this.value = formattedInput;
        });
        
       
        document.getElementById('application_date').value = "{{ today }}";
    });
</script>
{% endblock %}
